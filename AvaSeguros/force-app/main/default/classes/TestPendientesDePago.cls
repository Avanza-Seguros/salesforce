/**
 * @description       : 
 * @author            : ChangeMeIn@UserSettingsUnder.SFDoc
 * @group             : 
 * @last modified on  : 02-28-2025
 * @last modified by  : ChangeMeIn@UserSettingsUnder.SFDoc
**/
@isTest
public class TestPendientesDePago {
    
    @testSetup
    static void setupData() {
        Date fechaPendiente = Date.today().addDays(1); // 1 dÃ­a despuÃ©s de hoy

        // ğŸ”¹ Insertamos un pago PENDIENTE
        Pago_poliza__c pagoPendiente = new Pago_poliza__c(
            Estatus_del_Pago__c = 'Pendiente',
            Poliza_sc__c = '1234', // Campo usado en la fÃ³rmula
            Fecha_de_de_Vencimiento__c = fechaPendiente // Campo usado en la fÃ³rmula
        );
        insert pagoPendiente;

        System.debug('âœ… Pago Pendiente insertado - ID: ' + pagoPendiente.Id);
    }

    @isTest
    static void testActualizarPagoPendiente() {
        // ğŸ”¹ PASO 1: Verificamos que el pago pendiente existe antes del trigger
        Date fechaPendiente = Date.today().addDays(1); 
        
        Pago_poliza__c pagoAntes = [SELECT Id, Estatus_del_Pago__c, Poliza_sc__c, Fecha_de_de_Vencimiento__c
                                    FROM Pago_poliza__c 
                                    WHERE Poliza_sc__c = '1234' 
                                    AND Fecha_de_de_Vencimiento__c = :fechaPendiente
                                    AND Estatus_del_Pago__c = 'Pendiente'
                                    LIMIT 1];

        System.assertNotEquals(null, pagoAntes, 'âŒ ERROR: No se encontrÃ³ el Pago Pendiente');
        System.debug('ğŸ” Pago Pendiente antes de la actualizaciÃ³n - ID: ' + pagoAntes.Id);

        Test.startTest();
        
        // ğŸ”¹ PASO 2: Insertamos un pago PAGADO (Cobrado) para activar el Trigger `PolizasPendientes`
        Pago_poliza__c pagoCobrado = new Pago_poliza__c(
            Estatus_del_Pago__c = 'Cobrado', // Se considera pagado
            Poliza_sc__c = '1234', // Campo base de la fÃ³rmula
            Fecha_de_de_Vencimiento__c = fechaPendiente // Campo base de la fÃ³rmula
        );
        insert pagoCobrado; // ğŸ”¥ AquÃ­ se activa el Trigger `PolizasPendientes`

        System.debug('âœ… Pago Cobrado insertado - ID: ' + pagoCobrado.Id);

        Test.stopTest();
        
        // ğŸ”¹ PASO 3: Verificamos si el pago Pendiente se actualizÃ³
        Pago_poliza__c pagoDespues = [SELECT Id, Estatus_del_Pago__c, Poliza_sc__c, Fecha_de_de_Vencimiento__c
                                      FROM Pago_poliza__c 
                                      WHERE Poliza_sc__c = '1234' 
                                      AND Fecha_de_de_Vencimiento__c = :fechaPendiente
                                      LIMIT 1];

        System.debug('ğŸ” Pago Pendiente despuÃ©s del Trigger - ID: ' + pagoDespues.Id + 
                     ', Estatus: ' + pagoDespues.Estatus_del_Pago__c);

        // ğŸ”¹ PASO 4: Validamos que el estatus haya cambiado a "Actualizado"
        System.assertEquals('Actualizado', pagoDespues.Estatus_del_Pago__c, 
            'âŒ ERROR: El Trigger PolizasPendientes NO actualizÃ³ el pago Pendiente');
    }
}